<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>KT Cloud íˆ¬ì í‰ê°€</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
      min-height: 100vh;
      color: #fff;
    }

    .container {
      padding: 20px;
      max-width: 500px;
      margin: 0 auto;
    }

    /* í—¤ë” */
    .header {
      text-align: center;
      padding: 20px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }

    .logo {
      font-size: 0.8rem;
      color: #ff6b35;
      font-weight: 700;
      letter-spacing: 2px;
    }

    .title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-top: 5px;
      background: linear-gradient(90deg, #ffd700, #ff6b35);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* ë¡œê·¸ì¸ í™”ë©´ */
    #login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 50px;
    }

    .login-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .login-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .login-desc {
      color: #888;
      margin-bottom: 30px;
      text-align: center;
    }

    .input-group {
      width: 100%;
      margin-bottom: 20px;
    }

    .input-label {
      display: block;
      font-size: 0.9rem;
      color: #888;
      margin-bottom: 8px;
    }

    .input-field {
      width: 100%;
      padding: 15px 20px;
      font-size: 1.1rem;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      outline: none;
      transition: border-color 0.3s;
    }

    .input-field:focus {
      border-color: #ffd700;
    }

    .btn-primary {
      width: 100%;
      padding: 18px;
      font-size: 1.1rem;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #ffd700, #ff6b35);
      color: #000;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    .btn-primary:disabled {
      background: #444;
      color: #888;
      cursor: not-allowed;
    }

    /* ëŒ€ê¸° í™”ë©´ */
    #waiting-screen {
      display: none;
      text-align: center;
      padding-top: 50px;
    }

    .waiting-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .waiting-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .waiting-desc {
      color: #888;
    }

    .user-info {
      margin-top: 30px;
      padding: 20px;
      background: rgba(255, 215, 0, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(255, 215, 0, 0.3);
    }

    .user-name {
      font-size: 1.3rem;
      font-weight: 700;
      color: #ffd700;
    }

    .user-status {
      font-size: 0.9rem;
      color: #888;
      margin-top: 5px;
    }

    /* í‰ê°€ í™”ë©´ */
    #evaluation-screen {
      display: none;
    }

    .eval-progress {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
    }

    .eval-progress-text {
      font-size: 0.9rem;
      color: #888;
    }

    .eval-progress-bar {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      margin-top: 10px;
      overflow: hidden;
    }

    .eval-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ffd700, #ff6b35);
      border-radius: 3px;
      transition: width 0.3s;
    }

    .team-evaluation {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .team-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .team-number {
      background: linear-gradient(135deg, #ffd700, #ff6b35);
      color: #000;
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9rem;
      margin-right: 10px;
    }

    .team-topic {
      font-size: 1rem;
      font-weight: 500;
      line-height: 1.3;
      flex: 1;
    }

    .investment-section {
      margin-bottom: 15px;
    }

    .investment-label {
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
    }

    .investment-value {
      color: #ffd700;
      font-weight: 700;
    }

    .investment-slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.1);
      -webkit-appearance: none;
      appearance: none;
      outline: none;
    }

    .investment-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffd700, #ff6b35);
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(255, 215, 0, 0.5);
    }

    .investment-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .investment-btn {
      flex: 1;
      min-width: 60px;
      padding: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 8px;
      background: transparent;
      color: #ffd700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .investment-btn:active,
    .investment-btn.active {
      background: rgba(255, 215, 0, 0.2);
      border-color: #ffd700;
    }

    .feedback-section {
      margin-top: 15px;
    }

    .feedback-label {
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 8px;
    }

    .feedback-input {
      width: 100%;
      padding: 12px;
      font-size: 0.95rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      resize: none;
      min-height: 80px;
      outline: none;
    }

    .feedback-input:focus {
      border-color: rgba(255, 215, 0, 0.5);
    }

    .submit-section {
      padding: 20px 0;
      position: sticky;
      bottom: 0;
      background: linear-gradient(to top, #0a0a1a, transparent);
    }

    .total-investment {
      text-align: center;
      margin-bottom: 15px;
      padding: 15px;
      background: rgba(255, 215, 0, 0.1);
      border-radius: 12px;
    }

    .total-label {
      font-size: 0.9rem;
      color: #888;
    }

    .total-value {
      font-size: 2rem;
      font-weight: 900;
      color: #ffd700;
    }

    /* ì™„ë£Œ í™”ë©´ */
    #complete-screen {
      display: none;
      text-align: center;
      padding-top: 80px;
    }

    .complete-icon {
      font-size: 5rem;
      margin-bottom: 20px;
      animation: celebrate 1s ease;
    }

    @keyframes celebrate {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .complete-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: #ffd700;
      margin-bottom: 10px;
    }

    .complete-desc {
      color: #888;
      font-size: 1.1rem;
    }

    .complete-summary {
      margin-top: 40px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      text-align: left;
    }

    .summary-title {
      font-size: 1rem;
      color: #888;
      margin-bottom: 15px;
      text-align: center;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .summary-team {
      font-weight: 500;
    }

    .summary-amount {
      color: #ffd700;
      font-weight: 700;
    }

    /* ì—ëŸ¬ ë©”ì‹œì§€ */
    .error-message {
      display: none;
      background: rgba(255, 87, 87, 0.2);
      border: 1px solid rgba(255, 87, 87, 0.5);
      color: #ff5757;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }

    /* ì—ëŸ¬ íŒì—… */
    .error-popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .error-popup {
      background: linear-gradient(135deg, #1a1a3a 0%, #2a2a4a 100%);
      border: 1px solid rgba(255, 87, 87, 0.5);
      border-radius: 20px;
      padding: 30px;
      max-width: 90%;
      width: 350px;
      text-align: center;
      animation: popupIn 0.3s ease;
    }

    @keyframes popupIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .error-popup-icon {
      font-size: 3rem;
      margin-bottom: 15px;
    }

    .error-popup-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #ff5757;
      margin-bottom: 10px;
    }

    .error-popup-message {
      font-size: 1rem;
      color: #ccc;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .error-popup-btn {
      padding: 12px 40px;
      font-size: 1rem;
      font-weight: 700;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #ff5757, #ff3333);
      color: #fff;
      cursor: pointer;
    }

    /* ì˜ˆì‚° ê°€ì´ë“œ */
    .budget-guide {
      background: rgba(255, 215, 0, 0.1);
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
    }

    .budget-guide-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: #ffd700;
      margin-bottom: 8px;
    }

    .budget-guide-text {
      font-size: 0.85rem;
      color: #aaa;
      line-height: 1.4;
    }

    /* ì˜ˆì‚° ìƒíƒœ í‘œì‹œ */
    .total-investment.budget-ok {
      border: 2px solid rgba(0, 255, 150, 0.5);
      background: rgba(0, 255, 150, 0.1);
    }

    .total-investment.budget-ok .total-value {
      color: #00ff96;
    }

    .total-investment.budget-over {
      border: 2px solid rgba(255, 87, 87, 0.5);
      background: rgba(255, 87, 87, 0.1);
    }

    .total-investment.budget-over .total-value {
      color: #ff5757;
    }

    .budget-status {
      font-size: 0.85rem;
      margin-top: 8px;
    }

    .budget-status.ok {
      color: #00ff96;
    }

    .budget-status.over {
      color: #ff5757;
    }

    .budget-status.under {
      color: #ffd700;
    }

    /* í”¼ë“œë°± ì—ëŸ¬ ìƒíƒœ */
    .feedback-input.error {
      border-color: rgba(255, 87, 87, 0.7);
    }

    .feedback-error {
      color: #ff5757;
      font-size: 0.75rem;
      margin-top: 5px;
      display: none;
    }

    .feedback-counter {
      font-size: 0.75rem;
      color: #666;
      text-align: right;
      margin-top: 5px;
    }

    .feedback-counter.ok {
      color: #00ff96;
    }

    .feedback-counter.error {
      color: #ff5757;
    }

    /* ë¡œë”© */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top-color: #ffd700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- ì—ëŸ¬ íŒì—… -->
  <div class="error-popup-overlay" id="error-popup-overlay" onclick="closeErrorPopup(event)">
    <div class="error-popup">
      <div class="error-popup-icon" id="error-popup-icon">âš ï¸</div>
      <div class="error-popup-title" id="error-popup-title">ì œì¶œ ë¶ˆê°€</div>
      <div class="error-popup-message" id="error-popup-message">ì˜¤ë¥˜ ë©”ì‹œì§€</div>
      <button class="error-popup-btn" onclick="closeErrorPopup()">í™•ì¸</button>
    </div>
  </div>

  <div class="container">
    <!-- í—¤ë” -->
    <header class="header">
      <div class="logo">kt cloud 2026</div>
      <h1 class="title">ë¹„ì¦ˆë‹ˆìŠ¤ ì•„í‚¤í…íŠ¸ íˆ¬ì í‰ê°€</h1>
    </header>

    <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
    <div class="error-message" id="error-message"></div>

    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-screen">
      <div class="login-icon">ğŸ’¼</div>
      <h2 class="login-title">í‰ê°€ì ë¡œê·¸ì¸</h2>
      <p class="login-desc">ì„±í•¨ì„ ì…ë ¥í•˜ê³  í‰ê°€ì— ì°¸ì—¬í•´ì£¼ì„¸ìš”</p>

      <div class="input-group">
        <label class="input-label">ì„±í•¨ (ì§ì±…)</label>
        <input type="text" class="input-field" id="evaluator-name"
               placeholder="ì˜ˆ: í™ê¸¸ë™ ë¶€ì‚¬ì¥" autocomplete="off">
      </div>

      <button class="btn-primary" id="join-btn" onclick="joinEvaluation()">
        í‰ê°€ ì°¸ì—¬í•˜ê¸°
      </button>
    </div>

    <!-- ëŒ€ê¸° í™”ë©´ -->
    <div id="waiting-screen">
      <div class="waiting-icon">â³</div>
      <h2 class="waiting-title">í‰ê°€ ëŒ€ê¸° ì¤‘</h2>
      <p class="waiting-desc">ê´€ë¦¬ìê°€ í‰ê°€ë¥¼ ì‹œì‘í•˜ë©´<br>ìë™ìœ¼ë¡œ í‰ê°€ í™”ë©´ì´ í‘œì‹œë©ë‹ˆë‹¤</p>

      <div class="user-info">
        <div class="user-name" id="display-name"></div>
        <div class="user-status">âœ… ì ‘ì† ì™„ë£Œ</div>
      </div>
    </div>

    <!-- í‰ê°€ í™”ë©´ -->
    <div id="evaluation-screen">
      <!-- ì˜ˆì‚° ê°€ì´ë“œ -->
      <div class="budget-guide">
        <div class="budget-guide-title">ğŸ’° íˆ¬ì ì•ˆë‚´</div>
        <div class="budget-guide-text">
          ì´ <strong style="color:#ffd700">10ì–µì›</strong>ì„ 4ê°œ íŒ€ì— ë°°ë¶„í•´ì£¼ì„¸ìš”.<br>
          ê° íŒ€ì— ëŒ€í•œ <strong style="color:#ffd700">10ì ì´ìƒ</strong>ì˜ í”¼ë“œë°±ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.
        </div>
      </div>

      <div class="eval-progress">
        <div class="eval-progress-text">
          ê° íŒ€ì— íˆ¬ìí•  ê¸ˆì•¡ì„ ê²°ì •í•´ì£¼ì„¸ìš” (0~10ì–µ)
        </div>
        <div class="eval-progress-bar">
          <div class="eval-progress-fill" id="eval-progress-fill" style="width: 0%"></div>
        </div>
      </div>

      <div id="teams-container">
        <!-- íŒ€ í‰ê°€ ì¹´ë“œê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
      </div>

      <div class="submit-section">
        <div class="total-investment" id="total-investment-box">
          <div class="total-label">ì´ íˆ¬ì ê¸ˆì•¡ (ì •í™•íˆ 10ì–µì› í•„ìš”)</div>
          <div class="total-value"><span id="total-amount">0</span>ì–µì› / 10ì–µì›</div>
          <div class="budget-status" id="budget-status"></div>
        </div>
        <button class="btn-primary" id="submit-btn" onclick="submitEvaluation()">
          í‰ê°€ ì œì¶œí•˜ê¸°
        </button>
      </div>
    </div>

    <!-- ì™„ë£Œ í™”ë©´ -->
    <div id="complete-screen">
      <div class="complete-icon">ğŸ‰</div>
      <h2 class="complete-title">í‰ê°€ ì™„ë£Œ!</h2>
      <p class="complete-desc">ê²°ê³¼ ë°œí‘œë¥¼ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”</p>

      <div class="complete-summary">
        <div class="summary-title">ğŸ“Š ë‚´ íˆ¬ì ë‚´ì—­</div>
        <div id="summary-list">
          <!-- ìš”ì•½ í•­ëª©ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============ ìƒíƒœ ê´€ë¦¬ ============
    const socket = io();
    let sessionId = localStorage.getItem('kt_eval_session');
    let evaluatorName = localStorage.getItem('kt_eval_name');
    let currentState = null;
    let evaluations = {};

    // ============ í™”ë©´ ì „í™˜ ============
    function showScreen(screenId) {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('waiting-screen').style.display = 'none';
      document.getElementById('evaluation-screen').style.display = 'none';
      document.getElementById('complete-screen').style.display = 'none';

      if (screenId) {
        document.getElementById(screenId).style.display = 'block';
      }
    }

    function showError(message) {
      const el = document.getElementById('error-message');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    // ============ ë¡œê·¸ì¸ ============
    function joinEvaluation() {
      const nameInput = document.getElementById('evaluator-name');
      const name = nameInput.value.trim();

      if (!name) {
        showError('ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      const btn = document.getElementById('join-btn');
      btn.innerHTML = '<span class="loading"></span>ì ‘ì† ì¤‘...';
      btn.disabled = true;

      evaluatorName = name;
      localStorage.setItem('kt_eval_name', name);

      socket.emit('evaluator:join', { sessionId, name });
    }

    // ============ íŒ€ ì¹´ë“œ ë Œë”ë§ ============
    function renderTeamCards(teams) {
      const container = document.getElementById('teams-container');
      container.innerHTML = teams.map(team => {
        const savedEval = evaluations[team.id] || { investment: 0, feedback: '' };
        const feedbackLen = savedEval.feedback.length;
        const counterClass = feedbackLen >= 10 ? 'ok' : 'error';
        return `
          <div class="team-evaluation" id="team-${team.id}">
            <div class="team-header">
              <span class="team-number">${team.name}</span>
              <span class="team-topic">${team.topic}</span>
            </div>

            <div class="investment-section">
              <div class="investment-label">
                <span>íˆ¬ì ê¸ˆì•¡</span>
                <span class="investment-value" id="value-${team.id}">${savedEval.investment}ì–µì›</span>
              </div>
              <input type="range" class="investment-slider" id="slider-${team.id}"
                     min="0" max="10" step="1" value="${savedEval.investment}"
                     oninput="updateInvestment(${team.id}, this.value)">
              <div class="investment-buttons">
                ${[0, 3, 5, 7, 10].map(v => `
                  <button class="investment-btn ${savedEval.investment === v ? 'active' : ''}"
                          onclick="setInvestment(${team.id}, ${v})">${v}ì–µ</button>
                `).join('')}
              </div>
            </div>

            <div class="feedback-section">
              <div class="feedback-label">ğŸ’¬ í•œì¤„ í”¼ë“œë°± (í•„ìˆ˜, 10ì ì´ìƒ)</div>
              <textarea class="feedback-input ${feedbackLen < 10 && feedbackLen > 0 ? 'error' : ''}" id="feedback-${team.id}"
                        placeholder="ì´ íŒ€ì— ëŒ€í•œ ì˜ê²¬ì„ 10ì ì´ìƒ ë‚¨ê²¨ì£¼ì„¸ìš”"
                        oninput="updateFeedback(${team.id}, this.value)">${savedEval.feedback}</textarea>
              <div class="feedback-counter ${counterClass}" id="feedback-counter-${team.id}">${feedbackLen}/10ì</div>
            </div>
          </div>
        `;
      }).join('');

      updateTotalAmount();
    }

    // ============ íˆ¬ìê¸ˆ ì—…ë°ì´íŠ¸ ============
    function updateInvestment(teamId, value) {
      value = parseInt(value);
      evaluations[teamId] = evaluations[teamId] || { investment: 0, feedback: '' };
      evaluations[teamId].investment = value;

      document.getElementById(`value-${teamId}`).textContent = value + 'ì–µì›';
      document.getElementById(`slider-${teamId}`).value = value;

      // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll(`#team-${teamId} .investment-btn`).forEach(btn => {
        btn.classList.remove('active');
        if (parseInt(btn.textContent) === value) {
          btn.classList.add('active');
        }
      });

      updateTotalAmount();
      saveToLocalStorage();
    }

    function setInvestment(teamId, value) {
      updateInvestment(teamId, value);
    }

    function updateFeedback(teamId, value) {
      evaluations[teamId] = evaluations[teamId] || { investment: 0, feedback: '' };
      evaluations[teamId].feedback = value;

      // ê¸€ì ìˆ˜ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
      const counter = document.getElementById(`feedback-counter-${teamId}`);
      const textarea = document.getElementById(`feedback-${teamId}`);
      const len = value.length;

      counter.textContent = `${len}/10ì`;
      counter.className = 'feedback-counter ' + (len >= 10 ? 'ok' : 'error');
      textarea.className = 'feedback-input ' + (len > 0 && len < 10 ? 'error' : '');

      saveToLocalStorage();
    }

    function updateTotalAmount() {
      const total = Object.values(evaluations).reduce((sum, e) => sum + (e.investment || 0), 0);
      document.getElementById('total-amount').textContent = total;

      // ì˜ˆì‚° ìƒíƒœ í‘œì‹œ
      const box = document.getElementById('total-investment-box');
      const statusEl = document.getElementById('budget-status');

      box.classList.remove('budget-ok', 'budget-over');
      statusEl.className = 'budget-status';

      if (total === 10) {
        box.classList.add('budget-ok');
        statusEl.className = 'budget-status ok';
        statusEl.textContent = 'âœ… ì˜ˆì‚° ë°°ë¶„ ì™„ë£Œ!';
      } else if (total > 10) {
        box.classList.add('budget-over');
        statusEl.className = 'budget-status over';
        statusEl.textContent = `âŒ ì˜ˆì‚° ì´ˆê³¼! (${total - 10}ì–µì› ì´ˆê³¼)`;
      } else {
        statusEl.className = 'budget-status under';
        statusEl.textContent = `ğŸ’¡ ${10 - total}ì–µì› ë” ë°°ë¶„í•˜ì„¸ìš”`;
      }

      // ì§„í–‰ ìƒí™© í‘œì‹œ
      const filledCount = Object.values(evaluations).filter(e => e.investment > 0).length;
      const progress = (filledCount / 4) * 100;
      document.getElementById('eval-progress-fill').style.width = progress + '%';
    }

    // ============ ì—ëŸ¬ íŒì—… ============
    function showErrorPopup(title, message, icon = 'âš ï¸') {
      document.getElementById('error-popup-icon').textContent = icon;
      document.getElementById('error-popup-title').textContent = title;
      document.getElementById('error-popup-message').innerHTML = message;
      document.getElementById('error-popup-overlay').style.display = 'flex';
    }

    function closeErrorPopup(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('error-popup-overlay').style.display = 'none';
    }

    // ============ ì œì¶œ ============
    function submitEvaluation() {
      // ìœ íš¨ì„± ê²€ì‚¬
      const total = Object.values(evaluations).reduce((sum, e) => sum + (e.investment || 0), 0);

      // 1. ì˜ˆì‚°ì´ ì •í™•íˆ 10ì–µì¸ì§€ í™•ì¸
      if (total !== 10) {
        if (total > 10) {
          showErrorPopup(
            'ì˜ˆì‚° ì´ˆê³¼',
            `ì´ íˆ¬ì ê¸ˆì•¡ì´ <strong style="color:#ff5757">${total}ì–µì›</strong>ì…ë‹ˆë‹¤.<br>ì •í™•íˆ <strong>10ì–µì›</strong>ì„ ë°°ë¶„í•´ì£¼ì„¸ìš”.<br><br><small>${total - 10}ì–µì›ì„ ì¤„ì—¬ì£¼ì„¸ìš”.</small>`,
            'ğŸ’¸'
          );
        } else {
          showErrorPopup(
            'ì˜ˆì‚° ë¶€ì¡±',
            `ì´ íˆ¬ì ê¸ˆì•¡ì´ <strong style="color:#ffd700">${total}ì–µì›</strong>ì…ë‹ˆë‹¤.<br>ì •í™•íˆ <strong>10ì–µì›</strong>ì„ ë°°ë¶„í•´ì£¼ì„¸ìš”.<br><br><small>${10 - total}ì–µì›ì„ ë” ë°°ë¶„í•´ì£¼ì„¸ìš”.</small>`,
            'ğŸ’°'
          );
        }
        return;
      }

      // 2. ëª¨ë“  íŒ€ì— í”¼ë“œë°±ì´ 10ì ì´ìƒì¸ì§€ í™•ì¸
      const missingFeedbacks = [];
      currentState.teams.forEach(team => {
        const feedback = evaluations[team.id]?.feedback || '';
        if (feedback.length < 10) {
          missingFeedbacks.push({
            name: team.name,
            length: feedback.length
          });
        }
      });

      if (missingFeedbacks.length > 0) {
        const feedbackList = missingFeedbacks.map(t =>
          `<strong>${t.name}</strong>: ${t.length}ì (${10 - t.length}ì ë¶€ì¡±)`
        ).join('<br>');

        showErrorPopup(
          'í”¼ë“œë°± ë¶€ì¡±',
          `ëª¨ë“  íŒ€ì— 10ì ì´ìƒì˜ í”¼ë“œë°±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.<br><br>${feedbackList}`,
          'âœï¸'
        );
        return;
      }

      // ì œì¶œ ë°ì´í„° ìƒì„±
      const submitData = currentState.teams.map(team => ({
        teamId: team.id,
        investment: evaluations[team.id]?.investment || 0,
        feedback: evaluations[team.id]?.feedback || ''
      }));

      const btn = document.getElementById('submit-btn');
      btn.innerHTML = '<span class="loading"></span>ì œì¶œ ì¤‘...';
      btn.disabled = true;

      socket.emit('evaluator:submit', { sessionId, evaluations: submitData });
    }

    // ============ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ============
    function saveToLocalStorage() {
      localStorage.setItem('kt_eval_data', JSON.stringify(evaluations));
    }

    function loadFromLocalStorage() {
      const saved = localStorage.getItem('kt_eval_data');
      if (saved) {
        evaluations = JSON.parse(saved);
      }
    }

    // ============ Socket ì´ë²¤íŠ¸ ============
    socket.on('evaluator:joined', ({ sessionId: newSessionId, state }) => {
      sessionId = newSessionId;
      localStorage.setItem('kt_eval_session', sessionId);
      currentState = state;

      document.getElementById('display-name').textContent = evaluatorName;

      if (state.phase === 'waiting') {
        showScreen('waiting-screen');
      } else if (state.phase === 'evaluating') {
        showScreen('evaluation-screen');
        renderTeamCards(state.teams);
      }
    });

    socket.on('evaluator:restored', ({ sessionId: restoredId, evaluator, state }) => {
      sessionId = restoredId;
      evaluatorName = evaluator.name;
      currentState = state;

      document.getElementById('display-name').textContent = evaluatorName;

      if (evaluator.evaluated) {
        showCompleteSummary(evaluator.evaluations);
        showScreen('complete-screen');
      } else if (state.phase === 'waiting') {
        showScreen('waiting-screen');
      } else if (state.phase === 'evaluating' || state.phase === 'results') {
        loadFromLocalStorage();
        showScreen('evaluation-screen');
        renderTeamCards(state.teams);
      }
    });

    socket.on('evaluation:started', () => {
      if (currentState) {
        showScreen('evaluation-screen');
        renderTeamCards(currentState.teams);
      }
    });

    socket.on('state:update', (state) => {
      currentState = state;
    });

    socket.on('evaluator:submitted', ({ success }) => {
      if (success) {
        const savedData = currentState.teams.map(team => ({
          teamId: team.id,
          teamName: team.name,
          investment: evaluations[team.id]?.investment || 0
        }));
        showCompleteSummary(savedData);
        showScreen('complete-screen');
        localStorage.removeItem('kt_eval_data');
      }
    });

    socket.on('system:reset', () => {
      localStorage.removeItem('kt_eval_session');
      localStorage.removeItem('kt_eval_name');
      localStorage.removeItem('kt_eval_data');
      location.reload();
    });

    // ============ ì™„ë£Œ ìš”ì•½ í‘œì‹œ ============
    function showCompleteSummary(data) {
      const list = document.getElementById('summary-list');
      if (Array.isArray(data)) {
        list.innerHTML = data.map(item => {
          const teamName = item.teamName || currentState?.teams?.find(t => t.id === item.teamId)?.name || `íŒ€ ${item.teamId}`;
          return `
            <div class="summary-item">
              <span class="summary-team">${teamName}</span>
              <span class="summary-amount">${item.investment}ì–µì›</span>
            </div>
          `;
        }).join('');
      }
    }

    // ============ ì´ˆê¸°í™” ============
    loadFromLocalStorage();

    // ì €ì¥ëœ ì„¸ì…˜ì´ ìˆìœ¼ë©´ ìë™ ì¬ì ‘ì†
    if (sessionId && evaluatorName) {
      socket.emit('evaluator:join', { sessionId, name: evaluatorName });
    }

    // Enter í‚¤ë¡œ ë¡œê·¸ì¸
    document.getElementById('evaluator-name').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') joinEvaluation();
    });
  </script>
</body>
</html>
