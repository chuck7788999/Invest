<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Investment Day - 이벤트 이력</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      color: #fff;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    h1 {
      font-size: 1.8em;
      background: linear-gradient(90deg, #ffd700, #ffaa00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .back-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    .no-events {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255,255,255,0.5);
    }

    .no-events p {
      font-size: 1.2em;
      margin-bottom: 10px;
    }

    .event-list {
      display: grid;
      gap: 20px;
    }

    .event-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .event-card:hover {
      background: rgba(255,255,255,0.1);
      transform: translateY(-2px);
    }

    .event-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .event-name {
      font-size: 1.3em;
      font-weight: 600;
      color: #ffd700;
    }

    .event-date {
      font-size: 0.9em;
      color: rgba(255,255,255,0.5);
    }

    .event-stats {
      display: flex;
      gap: 30px;
      margin-bottom: 16px;
    }

    .stat {
      display: flex;
      flex-direction: column;
    }

    .stat-label {
      font-size: 0.8em;
      color: rgba(255,255,255,0.5);
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 1.4em;
      font-weight: 600;
    }

    .event-teams {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .team-badge {
      padding: 6px 12px;
      background: rgba(255,215,0,0.1);
      border: 1px solid rgba(255,215,0,0.3);
      border-radius: 20px;
      font-size: 0.85em;
    }

    .team-badge.rank-1 {
      background: rgba(255,215,0,0.2);
      border-color: #ffd700;
      color: #ffd700;
    }

    .team-badge.rank-2 {
      background: rgba(192,192,192,0.2);
      border-color: #c0c0c0;
      color: #c0c0c0;
    }

    .team-badge.rank-3 {
      background: rgba(205,127,50,0.2);
      border-color: #cd7f32;
      color: #cd7f32;
    }

    /* 상세 모달 */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 20px;
      max-width: 900px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 30px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .modal-title {
      font-size: 1.5em;
      color: #ffd700;
    }

    .modal-close {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.5em;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.3s;
    }

    .modal-close:hover {
      opacity: 1;
    }

    .detail-section {
      margin-bottom: 24px;
    }

    .detail-section h3 {
      font-size: 1.1em;
      color: rgba(255,255,255,0.7);
      margin-bottom: 12px;
    }

    .ranking-table {
      width: 100%;
      border-collapse: collapse;
    }

    .ranking-table th,
    .ranking-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .ranking-table th {
      color: rgba(255,255,255,0.5);
      font-weight: 500;
    }

    .ranking-table tr:hover {
      background: rgba(255,255,255,0.05);
    }

    .rank-medal {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9em;
    }

    .rank-medal.gold { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; }
    .rank-medal.silver { background: linear-gradient(135deg, #c0c0c0, #a8a8a8); color: #000; }
    .rank-medal.bronze { background: linear-gradient(135deg, #cd7f32, #b8860b); color: #fff; }
    .rank-medal.default { background: rgba(255,255,255,0.2); color: #fff; }

    .feedback-list {
      display: grid;
      gap: 10px;
    }

    .feedback-item {
      background: rgba(255,255,255,0.05);
      padding: 12px;
      border-radius: 8px;
      border-left: 3px solid #ffd700;
    }

    .feedback-evaluator {
      font-size: 0.8em;
      color: rgba(255,255,255,0.5);
      margin-bottom: 4px;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95em;
      transition: all 0.3s;
    }

    .btn-danger {
      background: rgba(220,53,69,0.2);
      border: 1px solid #dc3545;
      color: #dc3545;
    }

    .btn-danger:hover {
      background: rgba(220,53,69,0.3);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255,255,255,0.5);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Investment Day 이력</h1>
      <a href="/main" class="back-btn">메인으로</a>
    </header>

    <div id="content">
      <div class="loading">이벤트 이력을 불러오는 중...</div>
    </div>
  </div>

  <!-- 상세 모달 -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" id="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">이벤트 상세</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    let events = [];

    // 이벤트 목록 로드
    async function loadEvents() {
      try {
        const response = await fetch('/api/events');
        const data = await response.json();

        if (data.success) {
          events = data.events;
          renderEvents();
        } else {
          showNoEvents('이벤트를 불러오는데 실패했습니다.');
        }
      } catch (error) {
        showNoEvents('서버에 연결할 수 없습니다.');
      }
    }

    // 이벤트 목록 렌더링
    function renderEvents() {
      const content = document.getElementById('content');

      if (events.length === 0) {
        showNoEvents('저장된 이벤트가 없습니다.');
        return;
      }

      const html = `
        <div class="event-list">
          ${events.map(event => renderEventCard(event)).join('')}
        </div>
      `;

      content.innerHTML = html;
    }

    // 이벤트 카드 렌더링
    function renderEventCard(event) {
      const date = new Date(event.completedAt || event.createdAt);
      const dateStr = date.toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const sortedTeams = [...(event.teams || [])].sort((a, b) => a.rank - b.rank);

      return `
        <div class="event-card" onclick="showEventDetail('${event._id}')">
          <div class="event-header">
            <span class="event-name">${event.name}</span>
            <span class="event-date">${dateStr}</span>
          </div>
          <div class="event-stats">
            <div class="stat">
              <span class="stat-label">참여 평가자</span>
              <span class="stat-value">${event.stats?.totalEvaluators || 0}명</span>
            </div>
            <div class="stat">
              <span class="stat-label">총 투자금</span>
              <span class="stat-value">${event.stats?.totalInvestment || 0}억</span>
            </div>
          </div>
          <div class="event-teams">
            ${sortedTeams.slice(0, 4).map(team => `
              <span class="team-badge rank-${team.rank}">
                ${team.rank}위 ${team.name}
              </span>
            `).join('')}
          </div>
        </div>
      `;
    }

    // 이벤트 없음 표시
    function showNoEvents(message) {
      const content = document.getElementById('content');
      content.innerHTML = `
        <div class="no-events">
          <p>${message}</p>
          <p style="font-size: 0.9em;">이벤트 완료 후 저장하면 이력이 표시됩니다.</p>
        </div>
      `;
    }

    // 상세 모달 표시
    async function showEventDetail(eventId) {
      try {
        const response = await fetch(`/api/events/${eventId}`);
        const data = await response.json();

        if (!data.success) {
          alert('이벤트를 찾을 수 없습니다.');
          return;
        }

        const event = data.event;
        document.getElementById('modalTitle').textContent = event.name;
        document.getElementById('modalContent').innerHTML = renderEventDetail(event);
        document.getElementById('modalOverlay').classList.add('active');
      } catch (error) {
        alert('이벤트를 불러오는데 실패했습니다.');
      }
    }

    // 상세 내용 렌더링
    function renderEventDetail(event) {
      const sortedTeams = [...(event.teams || [])].sort((a, b) => a.rank - b.rank);

      return `
        <div class="detail-section">
          <h3>최종 순위</h3>
          <table class="ranking-table">
            <thead>
              <tr>
                <th>순위</th>
                <th>조</th>
                <th>주제</th>
                <th>투자금</th>
              </tr>
            </thead>
            <tbody>
              ${sortedTeams.map(team => `
                <tr>
                  <td>
                    <span class="rank-medal ${getRankClass(team.rank)}">${team.rank}</span>
                  </td>
                  <td>${team.name}</td>
                  <td>${team.topic}</td>
                  <td>${team.totalInvestment}억</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="detail-section">
          <h3>피드백 (${getTotalFeedbacks(sortedTeams)}개)</h3>
          ${sortedTeams.map(team => team.feedbacks?.length > 0 ? `
            <h4 style="margin: 16px 0 8px; color: #ffd700;">${team.name}</h4>
            <div class="feedback-list">
              ${team.feedbacks.map(fb => `
                <div class="feedback-item">
                  <div class="feedback-evaluator">${fb.evaluator}</div>
                  <div>${fb.content}</div>
                </div>
              `).join('')}
            </div>
          ` : '').join('')}
        </div>

        <div class="action-buttons">
          <button class="btn btn-danger" onclick="deleteEventConfirm('${event._id}')">
            이벤트 삭제
          </button>
        </div>
      `;
    }

    function getRankClass(rank) {
      if (rank === 1) return 'gold';
      if (rank === 2) return 'silver';
      if (rank === 3) return 'bronze';
      return 'default';
    }

    function getTotalFeedbacks(teams) {
      return teams.reduce((sum, team) => sum + (team.feedbacks?.length || 0), 0);
    }

    // 모달 닫기
    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
    }

    // 이벤트 삭제 확인
    async function deleteEventConfirm(eventId) {
      if (!confirm('정말 이 이벤트를 삭제하시겠습니까?\n삭제된 데이터는 복구할 수 없습니다.')) {
        return;
      }

      try {
        const response = await fetch(`/api/events/${eventId}`, {
          method: 'DELETE'
        });
        const data = await response.json();

        if (data.success) {
          closeModal();
          loadEvents();
        } else {
          alert('삭제에 실패했습니다.');
        }
      } catch (error) {
        alert('삭제에 실패했습니다.');
      }
    }

    // 모달 외부 클릭 시 닫기
    document.getElementById('modalOverlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        closeModal();
      }
    });

    // ESC 키로 모달 닫기
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    // 초기 로드
    loadEvents();
  </script>
</body>
</html>
